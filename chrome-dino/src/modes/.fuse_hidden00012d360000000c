// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GA mode  â€“  training & inference
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { Dino }              from '../dino.js';
import { GeneticAlgorithm }  from '../ai/ga.js';
import { NeuralNetwork }     from '../ai/nn.js';
import { getFitnessFunction } from '../ai/fitness.js';
import { AnalyticsTracker }  from '../analytics.js';
import { ModelStore }        from '../model-store.js';

export class GAMode {
  constructor(engine) {
    this.engine  = engine;
    this.ga      = null;
    this.tracker = new AnalyticsTracker();
    this.chart   = null;

    this.running            = false;
    this.fitnessKey         = 'score';
    this.bestFitnessAllTime = 0;
  }

  // â”€â”€ public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  startTraining(config) {
    this.fitnessKey = config.fitnessFunction || 'score';

    this.ga = new GeneticAlgorithm({
      populationSize:    config.populationSize,
      mutationRate:      config.mutationRate,
      crossoverRate:     config.crossoverRate,
      elitismCount:      config.elitismCount,
      inputSize:         10,
      selectionStrategy: config.selectionStrategy,
    });

    this.tracker.reset('ga', config);
    this.bestFitnessAllTime = 0;
    this._initChart();

    this.running = true;
    this._startGeneration(this.ga.createInitialPopulation());
  }

  startInference() {
    const data = ModelStore.loadBest('ga');
    if (!data) { alert('No trained GA model found! Train first.'); return; }

    const brain = NeuralNetwork.deserialize(data);
    const dino  = new Dino();
    dino.brain  = brain;

    this.engine.setDinos([dino]);
    this.engine.overlayText = 'ðŸ§¬ GA â€” Inference';

    this.engine.onAllDead = () => {
      this.running = false;
      document.getElementById('startStopBtn').textContent = 'Restart';
    };
    this.engine.onUpdate = (s) => this._updateLiveStats(s);
    this.engine.start();
    this.running = true;
  }

  stop()    { this.running = false; this.engine.stop(); }
  cleanup() {
    this.stop();
    if (this.chart) { this.chart.destroy(); this.chart = null; }
  }
  getTracker() { return this.tracker; }

  // â”€â”€ generation lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startGeneration(brains) {
    const dinos = brains.map(b => { const d = new Dino(); d.brain = b; return d; });

    this.engine.setDinos(dinos);
    this.engine.overlayText =
      `ðŸ§¬ GA â€” Gen ${this.ga.generation}  |  Pop ${dinos.length}`;

    this.tracker.startGeneration(this.ga.generation);

    this.engine.onAllDead = () => this._endGeneration();
    this.engine.onUpdate  = (s) => {
      this.tracker.recordAlive(s.aliveCount);
      this._updateLiveStats(s);
    };

    this.engine.start();
  }

  _endGeneration() {
    if (!this.running) return;

    const fitFn    = getFitnessFunction(this.fitnessKey);
    const fitnesses = this.engine.dinos.map(d => fitFn.calculate(d));

    this.tracker.endGeneration(fitnesses);

    // persist best
    const best = Math.max(...fitnesses);
    if (best > this.bestFitnessAllTime) {
      this.bestFitnessAllTime = best;
      const idx = fitnesses.indexOf(best);
      ModelStore.saveBest('ga', JSON.parse(this.ga.population[idx].serialize()));
    }
    ModelStore.saveLatest('ga', JSON.parse(this.ga.getBest().serialize()));

    this._updateChart();
    this._updateGenStats();

    // evolve & go again
    this.ga.evolve(fitnesses);
    this._startGeneration(this.ga.population);
  }

  // â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _updateLiveStats(s) {
    const el = document.getElementById('liveStats');
    if (!el) return;
    const stats = this.tracker.getLatestStats();
    el.innerHTML = `
      <div><strong>Score:</strong> ${s.score}</div>
      <div><strong>Speed:</strong> ${(s.speed || 0).toFixed(2)}</div>
      <div><strong>Alive:</strong> ${s.aliveCount} / ${s.totalCount}</div>
      ${stats ? `
        <div><strong>Generation:</strong> ${this.ga?.generation ?? 0}</div>
        <div><strong>Best (Gen):</strong> ${stats.bestFitness.toFixed(1)}</div>
        <div><strong>Avg (Gen):</strong> ${stats.avgFitness.toFixed(1)}</div>
        <div><strong>Best (All):</strong> ${this.bestFitnessAllTime.toFixed(1)}</div>
      ` : ''}`;
  }

  _updateGenStats() {
    const stats = this.tracker.getLatestStats();
    if (!stats) return;
    const el = document.getElementById('genStats');
    if (!el) return;
    el.innerHTML = `
      <div><strong>Generation:</strong> ${stats.generation}</div>
      <div><strong>Best Fitness:</strong> ${stats.bestFitness.toFixed(2)}</div>
      <div><strong>Avg Fitness:</strong> ${stats.avgFitness.toFixed(2)}</div>
      <div><strong>Median:</strong> ${stats.medianFitness.toFixed(2)}</div>
      <div><strong>Std Dev:</strong> ${stats.stdDev.toFixed(2)}</div>
      <div><strong>Best All-Time:</strong> ${this.bestFitnessAllTime.toFixed(2)}</div>
      <div><strong>Time:</strong> ${(stats.totalTime / 1000).toFixed(1)}s</div>`;
  }

  // â”€â”€ Chart.js â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _initChart() {
    const el = document.getElementById('fitnessChart');
    if (!el || typeof Chart === 'undefined') return;
    if (this.chart) this.chart.destroy();

    this.chart = new Chart(el, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Best',    data: [], borderColor: '#4caf50', borderWidth: 2, fill: false, pointRadius: 0 },
          { label: 'Average', data: [], borderColor: '#2196f3', borderWidth: 2, fill: false, pointRadius: 0 },
          { label: 'Worst',   data: [], borderColor: '#f44336', borderWidth: 1, fill: false, pointRadius: 0 },
        ],
      },
      options: {
        responsive: true, animation: false,
        scales: {
          x: { title: { display: true, text: 'Generation', color: '#aaa' }, ticks: { color: '#aaa' }, grid: { color: '#333' } },
          y: { title: { display: true, text: 'Fitness',    color: '#aaa' }, ticks: { color: '#aaa' }, grid: { color: '#333' } },
        },
        plugins: { legend: { labels: { color: '#ccc' } } },
      },
    });
  }

  _updateChart() {
    if (!this.chart) return;
    const d = this.tracker.getChartData();
    this.chart.data.labels           = d.labels;
    this.chart.data.datasets[0].data = d.bestFitness;
    this.chart.data.datasets[1].data = d.avgFitness;
    this.chart.data.datasets[2].data = d.worstFitness;
    this.chart.update();
  }
}
