// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  Application controller
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { GameEngine }  from './game-engine.js';
import { UserMode }    from './modes/user-mode.js';
import { GAMode }      from './modes/ga-mode.js';
import { NEATMode }    from './modes/neat-mode.js';
import { ModelStore }  from './model-store.js';
import { Dino }        from './dino.js';
import { Obstacle }    from './obstacle.js';

class App {
  constructor() {
    this.engine          = null;
    this.currentMode     = null;
    this.currentModeType = null;
    this.isTraining      = true;

    // pre-render shared sprites once
    Dino.loadImage();
    Obstacle.loadImage();

    this._bindHomeScreen();
  }

  // â”€â”€ home screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _bindHomeScreen() {
    document.querySelectorAll('.mode-card').forEach((card) => {
      card.addEventListener('click', () => {
        const mode = card.dataset.mode;
        if (mode === 'rl') { alert('RL mode coming soon!'); return; }
        this._enterGameScreen(mode);
      });
    });
  }

  // â”€â”€ enter game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _enterGameScreen(modeType) {
    document.getElementById('home-screen').style.display = 'none';
    document.getElementById('game-screen').style.display = 'flex';

    this.currentModeType = modeType;
    this.engine = new GameEngine('gameCanvas');

    const isAI   = modeType !== 'user';
    const isNEAT = modeType === 'neat';

    // toggle visibility of panels
    const show = (id, v) => {
      const el = document.getElementById(id);
      if (el) el.style.display = v ? (el.dataset.flex ? 'flex' : 'block') : 'none';
    };
    show('aiControls',       isAI);
    show('configPanel',      isAI);
    show('statsPanel',       isAI);
    show('chartContainer',   isAI);
    show('neatVizContainer', isNEAT);
    show('userScore',        !isAI);
    show('exportControls',   isAI);

    const titles = {
      user: 'ðŸŽ® User Play',
      ga:   'ðŸ§¬ GA (Neural Network)',
      neat: 'ðŸ§  NEAT',
    };
    document.getElementById('modeTitle').textContent = titles[modeType] || modeType;

    this.isTraining = true;
    this._updateModeToggle();
    this._bindGameControls();
  }

  // â”€â”€ game controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _bindGameControls() {
    const $ = (id) => document.getElementById(id);

    $('backBtn').onclick = () => this._goHome();

    $('startStopBtn').onclick = () => {
      if (this.engine?.running) this._stopMode();
      else                      this._startMode();
    };

    $('trainBtn').onclick = () => {
      if (this.engine?.running) this._stopMode();
      this.isTraining = true;
      this._updateModeToggle();
    };

    $('inferBtn').onclick = () => {
      if (this.engine?.running) this._stopMode();
      this.isTraining = false;
      this._updateModeToggle();
    };

    // exports
    $('exportJSON').onclick  = () => this.currentMode?.getTracker()?.downloadJSON();
    $('exportCSV').onclick   = () => this.currentMode?.getTracker()?.downloadCSV();
    $('exportModel').onclick = () => ModelStore.exportModel(this.currentModeType);
    $('importModel').onclick = () => ModelStore.importModel(this.currentModeType);
  }

  _startMode() {
    if (this.currentMode) this.currentMode.cleanup();

    switch (this.currentModeType) {
      case 'user':
        this.currentMode = new UserMode(this.engine);
        this.currentMode.start();
        break;

      case 'ga':
        this.currentMode = new GAMode(this.engine);
        this.isTraining
          ? this.currentMode.startTraining(this._getConfig())
          : this.currentMode.startInference();
        break;

      case 'neat':
        this.currentMode = new NEATMode(this.engine);
        this.isTraining
          ? this.currentMode.startTraining(this._getConfig())
          : this.currentMode.startInference();
        break;
    }

    document.getElementById('startStopBtn').textContent = 'Stop';
  }

  _stopMode() {
    this.currentMode?.stop();
    document.getElementById('startStopBtn').textContent = 'Start';
  }

  _getConfig() {
    const v = (id, fb) => {
      const el = document.getElementById(id);
      return el ? el.value : fb;
    };
    return {
      populationSize:    parseInt(v('popSize', '50'))    || 50,
      mutationRate:      parseFloat(v('mutRate', '0.1')) || 0.1,
      crossoverRate:     parseFloat(v('crossRate', '0.7')) || 0.7,
      elitismCount:      parseInt(v('elitism', '5'))     || 5,
      fitnessFunction:   v('fitnessSelect', 'combined'),
      selectionStrategy: v('selectionSelect', 'topN'),
      isTraining:        this.isTraining,
    };
  }

  _updateModeToggle() {
    const t = document.getElementById('trainBtn');
    const i = document.getElementById('inferBtn');
    if (!t || !i) return;
    t.classList.toggle('active', this.isTraining);
    i.classList.toggle('active', !this.isTraining);
  }

  // â”€â”€ navigate home â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _goHome() {
    if (this.currentMode) { this.currentMode.cleanup(); this.currentMode = null; }
    if (this.engine)      { this.engine.stop(); this.engine = null; }

    document.getElementById('game-screen').style.display = 'none';
    document.getElementById('home-screen').style.display = 'flex';

    // reset panels
    document.getElementById('startStopBtn').textContent = 'Start';
    const ls = document.getElementById('liveStats');  if (ls) ls.innerHTML = '';
    const gs = document.getElementById('genStats');   if (gs) gs.innerHTML = '';
  }
}

// â”€â”€ bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => new App());
