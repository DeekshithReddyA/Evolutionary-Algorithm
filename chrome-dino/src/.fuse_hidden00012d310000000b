// ──────────────────────────────────────────────
//  Model persistence  (localStorage + file I/O)
// ──────────────────────────────────────────────

export class ModelStore {
  // ── basic get / set ────────────────────────
  static save(key, data) {
    try {
      localStorage.setItem(key, typeof data === 'string' ? data : JSON.stringify(data));
      return true;
    } catch (e) { console.error('ModelStore.save:', e); return false; }
  }

  static load(key) {
    try {
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : null;
    } catch (e) { console.error('ModelStore.load:', e); return null; }
  }

  // ── best / latest helpers ──────────────────
  static saveBest(mode, data)    { return this.save(`best_${mode}`, data); }
  static saveLatest(mode, data)  { return this.save(`latest_${mode}`, data); }
  static loadBest(mode)          { return this.load(`best_${mode}`); }
  static loadLatest(mode)        { return this.load(`latest_${mode}`); }
  static hasSavedModel(mode)     { return localStorage.getItem(`best_${mode}`) !== null; }

  // ── file export / import ───────────────────
  static exportModel(mode) {
    const best = this.loadBest(mode);
    if (!best) { alert('No model saved for this mode yet.'); return; }

    const blob = new Blob([JSON.stringify(best, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = Object.assign(document.createElement('a'), {
      href: url, download: `${mode}_best_model.json`,
    });
    a.click();
    URL.revokeObjectURL(url);
  }

  static importModel(mode) {
    return new Promise((resolve) => {
      const input = Object.assign(document.createElement('input'), {
        type: 'file', accept: '.json',
      });
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) { resolve(false); return; }
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            this.saveBest(mode, data);
            alert('Model imported successfully!');
            resolve(true);
          } catch { alert('Invalid model file.'); resolve(false); }
        };
        reader.readAsText(file);
      };
      input.click();
    });
  }

  static clearAll() {
    ['best_ga', 'latest_ga', 'best_neat', 'latest_neat']
      .forEach(k => localStorage.removeItem(k));
  }
}
