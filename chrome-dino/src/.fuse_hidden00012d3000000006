// ──────────────────────────────────────────────
//  Analytics tracker – per-generation metrics
//  Supports JSON / CSV export for research use.
// ──────────────────────────────────────────────

export class AnalyticsTracker {
  constructor() {
    this.generations = [];
    this.currentGen  = null;
    this.startTime   = null;
    this.mode        = '';
    this.config      = {};
  }

  reset(mode = '', config = {}) {
    this.generations = [];
    this.currentGen  = null;
    this.startTime   = Date.now();
    this.mode        = mode;
    this.config      = { ...config };
  }

  startGeneration(genNumber) {
    this.currentGen = {
      number:        genNumber,
      startTime:     Date.now(),
      bestFitness:   0,
      avgFitness:    0,
      worstFitness:  0,
      medianFitness: 0,
      stdDev:        0,
      aliveOverTime: [],
      endTime:       null,
    };
  }

  recordAlive(count) {
    if (!this.currentGen) return;
    this.currentGen.aliveOverTime.push({
      time:  Date.now() - this.currentGen.startTime,
      count,
    });
  }

  endGeneration(fitnesses) {
    if (!this.currentGen || fitnesses.length === 0) return;

    const sorted   = [...fitnesses].sort((a, b) => b - a);
    const sum      = sorted.reduce((a, b) => a + b, 0);
    const avg      = sum / sorted.length;
    const variance = sorted.reduce((s, f) => s + (f - avg) ** 2, 0) / sorted.length;

    this.currentGen.endTime       = Date.now();
    this.currentGen.bestFitness   = sorted[0];
    this.currentGen.worstFitness  = sorted[sorted.length - 1];
    this.currentGen.avgFitness    = avg;
    this.currentGen.medianFitness = sorted[Math.floor(sorted.length / 2)];
    this.currentGen.stdDev        = Math.sqrt(variance);

    this.generations.push(this.currentGen);
    this.currentGen = null;
  }

  // ── accessors ──────────────────────────────
  getLatestStats() {
    const g = this.generations[this.generations.length - 1];
    if (!g) return null;
    return {
      generation:       g.number,
      bestFitness:      g.bestFitness,
      avgFitness:       g.avgFitness,
      worstFitness:     g.worstFitness,
      medianFitness:    g.medianFitness,
      stdDev:           g.stdDev,
      bestAllTime:      Math.max(...this.generations.map(x => x.bestFitness)),
      totalGenerations: this.generations.length,
      totalTime:        Date.now() - this.startTime,
    };
  }

  getChartData() {
    return {
      labels:       this.generations.map(g => g.number),
      bestFitness:  this.generations.map(g => g.bestFitness),
      avgFitness:   this.generations.map(g => g.avgFitness),
      worstFitness: this.generations.map(g => g.worstFitness),
      medianFitness:this.generations.map(g => g.medianFitness),
    };
  }

  // ── export ─────────────────────────────────
  exportJSON() {
    return JSON.stringify({
      mode:             this.mode,
      config:           this.config,
      startTime:        this.startTime,
      totalTime:        Date.now() - this.startTime,
      bestFitnessAllTime: this.generations.length
        ? Math.max(...this.generations.map(g => g.bestFitness))
        : 0,
      generations: this.generations,
    }, null, 2);
  }

  exportCSV() {
    const hdr = 'generation,bestFitness,avgFitness,worstFitness,medianFitness,stdDev,durationMs\n';
    const rows = this.generations.map(g =>
      [g.number, g.bestFitness.toFixed(2), g.avgFitness.toFixed(2),
       g.worstFitness.toFixed(2), g.medianFitness.toFixed(2),
       g.stdDev.toFixed(2), g.endTime - g.startTime].join(','),
    ).join('\n');
    return hdr + rows;
  }

  downloadJSON() {
    this._download(this.exportJSON(), 'application/json',
      `analytics_${this.mode}_${Date.now()}.json`);
  }

  downloadCSV() {
    this._download(this.exportCSV(), 'text/csv',
      `analytics_${this.mode}_${Date.now()}.csv`);
  }

  _download(content, mime, filename) {
    const blob = new Blob([content], { type: mime });
    const url  = URL.createObjectURL(blob);
    const a    = Object.assign(document.createElement('a'), { href: url, download: filename });
    a.click();
    URL.revokeObjectURL(url);
  }
}
